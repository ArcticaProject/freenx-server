#!/bin/bash
# Etersoft, 2010
# 2010 (c) Devaev Maxim, <mdevaev@etersoft.ru>
# 2010 (c) Baranov Denis, <baraka@etersoft.ru>
#
# rxsetup - script for fast configuration of NX
#
#####

unlock_nx_user()
{
        passwd -u nx
}

start_sshd()
{
        # FIXME Lav: нужно воспользоваться distr_vendor для определения системы
        for sshd in ssh sshd openssh opensshd; do
                if [ -e /etc/init.d/$sshd ]; then
                        /etc/init.d/$sshd start
                        RETVAL="$?"
                        chkconfig $sshd on || update-rc.d $sshd defaults
                fi
        done

        return "$RETVAL"
}

enable_cupsd()
{
        chmod 755 /usr/sbin/cupsd && \
        chmod 711 /usr/lib/cups/backend/ipp
}

nx_install()
{
        nxsetup --setup-nomachine-key --install
}

start_freenx_server()
{
        SERVICECOMMAND="/etc/init.d/freenx-server"
        chkconfig freenx-server on || update-rc.d freenx-server defaults
        # Without direct dependency to /etc/init.d
        $SERVICECOMMAND start
}

rxsetup_stages()
{
        unlock_nx_user && \
        start_sshd && \
        enable_cupsd && \
        nx_install && \
        start_freenx_server
}


##### Main #####
rxsetup_stages >rxsetup.log 2>&1
if [ "$?" -ne 0 ]; then
        echo "Configuration error, see rxsetup.log for details"
        exit 1
else
        echo "Complete. Now, you may use nxclient for connection to this server"
fi

